<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.1/dist/dexie.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMGPT Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Martian+Mono&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Martian Mono', monospace;
            margin: 40px;
            transition: background-color 0.3s, color 0.3s;
            background-color: #333;
            color: #fff;
            background-image: url('data:image/svg+xml;utf8,<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M0 20l20-20 20 20-20 20z" fill="%23333" /><path d="M0 10l10-10 10 10-10 10zM30 0l10 10-10 10zM10 30l20-20 10 10-20 20z" fill="%23444" /></svg>');
        }

        .logo {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 2px #aaa;
        }

        .chat-box {
            border: 1px solid #28a745;
            padding: 20px;
            height: 300px;
            overflow-y: scroll;
            background-color: #444;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .loading {
            display: none;
            font-size: 1.2em;
            margin-top: 10px;
            color: #28a745;
        }

        .dot {
            animation: blink 1.4s infinite both;
            font-size: 2em;
            width: 24px;
            height: 24px;
            margin: 0 5px;
            display: inline-block;
            color: #28a745;
        }

        input[type="text"], button, select {
            margin-top: 10px;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            outline: none;
            font-size: 1em;
            background-color: #555;
            color: #fff;
        }

        button {
            cursor: pointer;
            background-color: #28a745;
            color: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        button:hover {
            background-color: #218838;
        }

        button.toggle-mode {
            margin-bottom: 10px;
            background-color: #6c757d;
        }

        button.toggle-mode:hover {
            background-color: #565e64;
        }

        .save-prompt-ui, .folder-list {
            margin-top: 20px;
        }

        .folder {
            cursor: pointer;
        }

        .delete-folder-icon {
    color: red;
    cursor: pointer;
    margin-left: 10px;
}
.template-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px;
    border: 1px solid #555;
    margin-top: 5px;
    cursor: pointer;
}

.template-item span {
    margin-left: 10px;
}

    </style>
</head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

<body>
    <div class="logo">TIMGPT</div>
    <button class="toggle-mode" onclick="toggleDarkMode()">Toggle Dark Mode</button>

    <div class="session-controls">
        <button onclick="startNewSession()">Start New Session</button>
        <select id="previousSessions" onchange="loadSession()">
            <option value="">Select previous session</option>
        </select>
    </div>

    <!-- Folder creation UI -->
    <div>
        <input type="text" id="newFolderName" placeholder="New Folder Name">
        <button onclick="createNewFolder()">Create Folder</button>
    </div>

    <!-- Save Prompt UI -->
    <div class="save-prompt-ui">
        <input type="text" id="folderName" placeholder="Type or select folder" list="folderOptions">
        <datalist id="folderOptions"></datalist>
        <button onclick="savePromptToFolder()">Save Prompt to Folder</button>
    </div>

    <!-- Dynamic Folder and Prompt List -->
    <div class="folder-list" id="folderListContainer"></div>

    <div class="chat-box" id="chatBox"></div>
    <div class="loading">Generating response<span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div>
    <textarea id="userInput" rows="1" placeholder="Type a message..." onkeydown="if(event.key === 'Enter') sendMessage();" oninput="adjustTextareaHeight(this)"></textarea>
    <button onclick="sendMessage()">Send</button>
    <div class="template-controls">
        <input type="text" id="templateName" placeholder="Template Name">
        <textarea id="templateInput" rows="1" placeholder="Type a template..." oninput="adjustTextareaHeight(this, 'templateHeight')"></textarea>
        <button onclick="saveTemplate()">Save Template</button>
    </div>
    <input type="file" id="excelUpload" accept=".xlsx" onchange="handleExcelUpload(event)">
<button onclick="uploadExcel()">Upload Excel</button>

    <div class="load-template-controls">
        <select id="savedTemplates" onchange="loadTemplate()"></select>
        <button onclick="deleteSelectedTemplate()">Delete Selected Template</button>
    </div>
    
    
  
    

    <script>
        function typeResponse(message, index = 0) {
            const chatBox = document.getElementById('chatBox');
            if (index < message.length) {
                chatBox.innerHTML += message.charAt(index);
                setTimeout(() => typeResponse(message, index + 1), 30);
            } else {
                const loading = document.querySelector('.loading');
                loading.style.display = 'none';
                saveSession();
            }
        }
        function saveTemplate() {
    const templateName = document.getElementById('templateName').value;
    const templateContent = document.getElementById('templateInput').value;

    if (templateName && templateContent) {
        // Save to IndexedDB
        saveTemplateToDB(templateName, templateContent);
    } else {
        console.log("Either template name or content is missing!"); // Debugging line
    }
}

function deleteSelectedTemplate() {
    const templateDropdown = document.getElementById('savedTemplates');
    const templateName = templateDropdown.value;
    if (templateName) {
        deleteTemplateByName(templateName);
    }
}




function loadTemplateList() {
    // Get all templates from IndexedDB
    getAllTemplates();
}






function loadTemplate() {
    const selectedTemplateName = document.getElementById('savedTemplates').value;
    if (selectedTemplateName) {
        getTemplateByName(selectedTemplateName);
    }
}






function adjustTextareaHeight(element, storageKey) {
    element.style.height = "1px";
    element.style.height = (element.scrollHeight) + "px";
    localStorage.setItem(storageKey, element.style.height);
}



function sendMessage() {
    const input = document.getElementById('userInput'); // Move this line to the top
    
    if (input.value.toLowerCase().includes("game sheet")) {
        getGameSheetAnswer(input.value);
    } else {
        const chatBox = document.getElementById('chatBox');
        const loading = document.querySelector('.loading');

        chatBox.innerHTML += '<div>User: ' + input.value + '</div>';
        loading.style.display = 'block';

        fetch('/ask', {
            method: 'POST',
            body: new URLSearchParams('message=' + input.value),
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            }
        })
        .then(response => response.json())
        .then(data => {
            chatBox.innerHTML += '<div>Bot: ';
            typeResponse(data.response);
            chatBox.innerHTML += '</div>';
            chatBox.scrollTop = chatBox.scrollHeight;
            input.value = '';
 });
    }
}


        function toggleDarkMode() {
            const body = document.body;
            const chatBox = document.getElementById('chatBox');
            body.classList.toggle('dark-mode');
            chatBox.classList.toggle('dark-mode');
        }

        function saveSession() {
    const chatBox = document.getElementById('chatBox');
    saveSessionToDB(chatBox.innerHTML);
}
function saveSessionToDB(content) {
    db.sessions.put({content: content}).then(function(id) {
        console.log("Saved session with ID", id);
        updateSessionList(); // refresh the session list after saving
    });
}
function getGameSheetAnswer(question) {
    // Example: Detecting question about Lakers' wins
    console.log("Inside getGameSheetAnswer with question:", question);
    if (question.includes("Lakers") && question.includes("win")) {
        db.excelData.get("Game").then(sheetData => {
            let wins = 0;
            for (let row of sheetData.data) {
                if (row.winningTeam === "Lakers") {
                    wins++;
                }
            }
            const response = `The Lakers have won ${wins} times according to the Game sheet.`;
            
            // Display the answer in your GUI
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += '<div>Bot: ' + response + '</div>';
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    } else {
        // Here, you can add other conditions or default to asking the AI
    }
}



function updateSessionList() {
    const sessionSelect = document.getElementById('previousSessions');
    // Clear previous options
    sessionSelect.innerHTML = '<option value="">Select previous session</option>';

    // Fetch all sessions from IndexedDB
    db.sessions.toArray().then(function(sessions) {
        sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session.id; // We use the ID of the session as the value
            option.text = new Date(session.id).toISOString(); // Convert the ID (timestamp) to a readable string
            sessionSelect.appendChild(option);
        });
    });
}


function loadSession() {
    const chatBox = document.getElementById('chatBox');
    const sessionSelect = document.getElementById('previousSessions');
    const selectedSessionId = parseInt(sessionSelect.value);

    if (selectedSessionId) {
        db.sessions.get(selectedSessionId).then(function(session) {
            if (session) {
                chatBox.innerHTML = session.content;
            }
        });
    }
}


        function startNewSession() {
            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML = '';
            saveSession();
        }

        function savePromptToFolder() {
            const userInput = document.getElementById('userInput').value;
            const folderName = document.getElementById('folderName').value;
            if (userInput && folderName) {
                const folders = JSON.parse(localStorage.getItem('folders') || '{}');
                if (!folders[folderName]) {
                    folders[folderName] = [];
                }
                folders[folderName].push(userInput);
                localStorage.setItem('folders', JSON.stringify(folders));
                loadFolderList();
                document.getElementById('userInput').value = '';
            } else {
                alert("Please specify a folder and type a prompt before saving.");
            }
        }

        function createNewFolder() {
            const newFolderName = document.getElementById('newFolderName').value;
            if (newFolderName) {
                const folders = JSON.parse(localStorage.getItem('folders') || '{}');
                if (!folders[newFolderName]) {
                    folders[newFolderName] = [];
                    localStorage.setItem('folders', JSON.stringify(folders));
                    loadFolderList();
                    document.getElementById('newFolderName').value = '';
                } else {
                    alert('Folder already exists. Choose a different name.');
                }
            } else {
                alert('Please specify a name for the folder.');
            }
        }

        function deleteFolder(folderName) {
            const folders = JSON.parse(localStorage.getItem('folders') || '{}');
            delete folders[folderName];
            localStorage.setItem('folders', JSON.stringify(folders));
            loadFolderList();
        }
        // Save a template to DB
function saveTemplateToDB(name, content) {
    db.templates.put({name: name, content: content}).then(function(id) {
        console.log("Saved with ID", id);
        loadTemplateList(); // refresh the list after saving
    });
}

// Get all templates from DB
function getAllTemplates() {
    db.templates.toArray().then(function(templates) {
        const templateDropdown = document.getElementById('savedTemplates');
        templateDropdown.innerHTML = ''; // Clear dropdown

        templates.forEach(template => {
            const option = document.createElement('option');
            option.value = template.name;
            option.textContent = template.name + " âŒ";
            option.title = "Click to load. To delete, select and use the red 'x' next to the dropdown.";
            templateDropdown.appendChild(option);
        });
    });
}

// Get a specific template by name from DB
function getTemplateByName(name) {
    db.templates.where("name").equals(name).first().then(function(template) {
        if (template) {
            document.getElementById('userInput').value = template.content;
        }
    });
}

// Delete a template by name from DB
function deleteTemplateByName(name) {
    db.templates.where("name").equals(name).delete().then(function() {
        console.log("Deleted template named", name);
        loadTemplateList(); // refresh the list after deletion
    });
}

function handleExcelUpload(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });

        workbook.SheetNames.forEach(sheetName => {
            // Convert sheet to JSON
            const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
            
            // Save to IndexedDB or process as needed
            saveSheetToDB(sheetName, sheetData); 
            // Note: You'll have to implement the saveSheetToDB function.
        });
    };
    reader.readAsBinaryString(file);
}
  
        function deletePrompt(folderName, promptIndex) {
            const folders = JSON.parse(localStorage.getItem('folders') || '{}');
            folders[folderName].splice(promptIndex, 1);
            localStorage.setItem('folders', JSON.stringify(folders));
            loadFolderList();
        }
        function saveSheetToDB(sheetName, sheetData) {
    db.excelData.put({
        sheetName: sheetName,
        data: sheetData
    }).then(function(id) {
        console.log("Saved sheet data with ID", id);
    }).catch(function(error) {
        console.error("Error saving sheet data:", error);
    });
}
function getSheetData(sheetName) {
    db.excelData.where("sheetName").equals(sheetName).first().then(function(entry) {
        console.log("Retrieved data for sheet:", entry.sheetName);
        console.log(entry.data);
        // Process the data as needed
    }).catch(function(error) {
        console.error("Error retrieving sheet data:", error);
    });
}
function getSheetData(sheetName) {
    return db.excelData.where("name").equals(sheetName).first();
}
function getRowsBasedOnColumn(data, columnName, value) {
    return data.content.filter(row => row[columnName] === value);
}

        function loadFolderList() {
            const folders = JSON.parse(localStorage.getItem('folders') || '{}');
            const folderListContainer = document.getElementById('folderListContainer');
            const folderOptions = document.getElementById('folderOptions');
            folderListContainer.innerHTML = '';
            folderOptions.innerHTML = '';

            for (let folder in folders) {
                const option = document.createElement('option');
                option.value = folder;
                folderOptions.appendChild(option);

                const folderDiv = document.createElement('div');
                folderDiv.className = 'folder';
                folderDiv.innerHTML = folder;
                const deleteIcon = document.createElement('span');
deleteIcon.className = 'delete-folder-icon';
deleteIcon.innerHTML = '&#10006;'; // Unicode for 'x'
deleteIcon.onclick = (event) => {
    event.stopPropagation(); // Prevents folder from toggling
    if (confirm('Are you sure you want to delete this folder and all its prompts?')) {
        delete folders[folder];
        localStorage.setItem('folders', JSON.stringify(folders));
        loadFolderList();
    }
};
folderDiv.appendChild(deleteIcon);

                const deleteFolderBtn = document.createElement('span');
                deleteFolderBtn.className = 'delete-btn';
                
                deleteFolderBtn.onclick = () => deleteFolder(folder);
                folderDiv.appendChild(deleteFolderBtn);

                const promptList = document.createElement('div');
                promptList.style.display = 'none';
                folders[folder].forEach((prompt, index) => {
                    const promptDiv = document.createElement('div');
                    promptDiv.textContent = prompt;
                    promptDiv.onclick = () => {
                        document.getElementById('userInput').value = prompt;
                    };
                    const deletePromptBtn = document.createElement('span');
                    deletePromptBtn.className = 'delete-btn';
                    deletePromptBtn.textContent = 'Delete';
                    deletePromptBtn.onclick = (e) => {
                        e.stopPropagation();
                        deletePrompt(folder, index);
                    };
                    promptDiv.appendChild(deletePromptBtn);
                    promptList.appendChild(promptDiv);
                });

                folderDiv.onclick = () => {
                    if (promptList.style.display === 'none') {
                        promptList.style.display = 'block';
                    } else {
                        promptList.style.display = 'none';
                    }
                };

                folderDiv.appendChild(promptList);
                folderListContainer.appendChild(folderDiv);
            }
        }

       // Create a new Dexie instance
var db = new Dexie("TIMGPTDatabase");

// Define your database schema
db.version(1).stores({
    templates: 'id++, name, content',
    sessions: 'id++, content',
    excelData: 'sheetName, data' // <-- This is the new line you added
});

// Open the database
db.open().catch(function (error) {
    console.error("Oops! " + error);
});


       // Initially load the folder list and set input heights
loadFolderList();
loadTemplateList();

// Set heights for userInput and templateInput from local storage
document.getElementById('userInput').style.height = localStorage.getItem('userInputHeight') || 'auto';
document.getElementById('templateInput').style.height = localStorage.getItem('templateHeight') || 'auto';


    
    </script>
</body>
</html>